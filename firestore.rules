rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Allow reads for all signed-in users
    match /{document=**} {
      allow read: if request.auth != null;
    }

    // ðŸš« Prevent any writes to /irrigation_devices/Users
    match /irrigation_devices/Users {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // âœ… Restrict fertigation queue writes to allowed emails from /irrigation_devices/Users
    match /irrigation_devices/{deviceId}/fertigation_queue/{docId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null
        && request.auth.token.email in get(/databases/$(database)/documents/irrigation_devices/Users).data.allowedEmails;
    }
  }
}