<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Irrigation Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
  <script src="https://cdn.jsdelivr.net/npm/moment@2.29.4/min/moment.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-moment@1.0.0/dist/chartjs-adapter-moment.min.js"></script>
  <style>
    .sortable { cursor: pointer; user-select: none; }
    .sortable:hover { background-color: #f8f9fa; }
    .sort-icon { font-size: 0.8em; margin-left: 5px; }
  </style>
</head>
<body>
<div class="container py-4">
  <!-- Header with title and profile button -->
  <div class="position-relative mb-4">
    <h2 class="text-center animate__animated animate__fadeInDown">Irrigation Monitoring Dashboard</h2>

    <!-- User Profile Button (top-right overlay) -->
    <button
      id="user-menu-btn"
      class="btn btn-outline-primary d-flex align-items-center position-absolute top-0 end-0 me-3"
      data-bs-toggle="modal"
      data-bs-target="#userModal"
    >
      <img
        id="user-avatar"
        src="images/user-default.png"
        alt="User"
        style="width:32px;height:32px;border-radius:50%;margin-right:8px;"
      />
      <span id="user-name">Sign in with Google</span>
    </button>
  </div>

  <p id="last-updated-time" class="text-center text-muted">Last updated: Loading...</p>

  <!-- Tabs -->
  <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" role="tab">Dashboard</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="fertigation-logs-tab" data-bs-toggle="tab" data-bs-target="#fertigation-logs" type="button" role="tab">Fertigation Logs</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="timer-history-tab" data-bs-toggle="tab" data-bs-target="#timer-history" type="button" role="tab">Timer History</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="valve-groups-tab" data-bs-toggle="tab" data-bs-target="#valve-groups" type="button" role="tab">Valve Groups</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="pressure-analysis-tab" data-bs-toggle="tab" data-bs-target="#pressure-analysis" type="button" role="tab">Pressure Analysis</button>
    </li>
  </ul>

  <!-- Tab Content -->
  <div class="tab-content pt-3" id="dashboardTabsContent">
    <div class="tab-pane fade show active animate__animated animate__fadeInUp" id="dashboard" role="tabpanel">
      <!-- General Dashboard: display summary visuals, integrate electricity, pressure, and timer overview neatly here -->
      <div id="dashboard-overview" class="mt-3">
        <div class="row gy-3">
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Sump Status</h5>
                <div id="electricity-status" class="mb-0">
                  <img id="motor-image" src="images/motor-off.png" alt="Motor">
                  <div id="motor-status-text" class="mt-2 fw-bold text-secondary">Loading...</div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Pressure (In/Out)</h5>
                <div class="d-flex justify-content-around align-items-center">
                  <!-- Input Pressure Gauge -->
                  <div class="text-center">
                    <canvas id="input-pressure-gauge" width="120" height="120"></canvas>
                    <p class="mt-2 fw-bold">Input</p>
                  </div>
                  <!-- Output Pressure Gauge -->
                  <div class="text-center">
                    <canvas id="output-pressure-gauge" width="120" height="120"></canvas>
                    <p class="mt-2 fw-bold">Output</p>
                  </div>
                </div>
                <!-- Add linear gauge for pressure difference -->
                <div class="mt-3">
                  <div class="text-center mb-2">
                    <span id="pressure-difference-value" style="font-size: 1.5rem; font-weight: bold;">0.00 difference (bar)</span>
                  </div>
                  <div class="progress" style="height: 20px;">
                    <div id="pressure-difference-bar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Current Timer</h5>
                <div class="d-flex flex-column align-items-center">
                  <div id="timer-images"></div>
                  <p id="dashboard-current-timer" class="text-primary mt-2">Loading...</p>
                  <!-- Add: Valves list display -->
                  <div id="dashboard-current-valves" class="mt-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row gy-3 mt-3">
          <!-- Voltage & Current Chart Card -->
          <div class="col-md-12 col-lg-6 mb-4">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title text-muted text-center">Voltage & Current (3 Phase)</h5>
                <div class="d-flex justify-content-around align-items-center" style="padding-top: 40px !important;">
                  <div class="text-center" style="background-color: #ff4d4f; color: white; padding: 20px; border-radius: 10px; width: 150px;">
                    <h6>R</h6>
                    <p id="voltage-phase-1-box" class="mb-0">0 V</p>
                    <p id="current-phase-1-box" class="mb-0">0 A</p>
                  </div>
                  <div class="text-center" style="background-color: #f7c600; color: white; padding: 20px; border-radius: 10px; width: 150px;">
                    <h6>Y</h6>
                    <p id="voltage-phase-2-box" class="mb-0">0 V</p>
                    <p id="current-phase-2-box" class="mb-0">0 A</p>
                  </div>
                  <div class="text-center" style="background-color: #007bff; color: white; padding: 20px; border-radius: 10px; width: 150px;">
                    <h6>B</h6>
                    <p id="voltage-phase-3-box" class="mb-0">0 V</p>
                    <p id="current-phase-3-box" class="mb-0">0 A</p>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- Add Next Timer Card -->
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">Next Timer</h5>
                <div class="d-flex flex-column align-items-center">
                  <img id="next-timer-image" src="images/none.png" alt="Next Timer" style="width: 150px;" />
                  <p id="dashboard-next-timer" class="text-secondary mt-2">Loading...</p>
                </div>
              </div>
            </div>
          </div>
          <!-- Add Fertigation Status Card -->
          <div class="col-md-6 col-lg-3 mb-4">
            <div class="card h-100" id="fertigation-status-card">
              <div class="card-body text-center" style="padding: 10px 0;">
                <h5 class="card-title text-muted">Fertigation Status</h5>
                <div class="d-flex flex-column align-items-center">
                  <div class="fertigation-indicator mb-2">
                    <div id="fertigation-status-dot" class="status-dot"></div>
                    <span id="fertigation-status-text">Inactive</span>
                  </div>
                  <div id="fertigation-timer" class="text-muted"></div>
                  <div id="fertigation-notes-display" class="small text-muted mt-2"></div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row gy-3 mt-3">
          <div class="col-12">
            <div class="card h-100">
              <div class="card-body text-center">
                <h5 class="card-title text-muted">AI Anomaly Detection</h5>
                <div id="ai-insights" class="text-start"></div>
                <button onclick="runAiAnomalyTest()" class="btn btn-outline-primary mt-3">Run AI Test</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="tab-pane fade" id="timer-history" role="tabpanel">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <label for="history-from-date" class="me-2">From:</label>
        <input type="date" id="history-from-date" class="form-control me-3" style="max-width: 200px;">
        <label for="history-to-date" class="me-2">To:</label>
        <input type="date" id="history-to-date" class="form-control me-3" style="max-width: 200px;">
        <label for="history-timer-name-dropdown" class="me-2">Timer Name:</label>
        <select id="history-timer-name-dropdown" class="form-select me-3" style="max-width: 200px;">
          <option value="">All Timers</option>
        </select>
        <button id="fetch-history-btn" class="btn btn-primary">Fetch</button>
      </div>
      <div id="timer-history-content" class="mt-3">
        <p class="text-center text-muted">Loading timer history...</p>
      </div>
    </div>
    
    <div class="tab-pane fade" id="valve-groups" role="tabpanel">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <p class="text-muted">Select a valve group to view pressure history.</p>
      </div>
      <div id="valve-group-cards" class="row g-3 mt-3"></div>
    </div>

    <div class="tab-pane fade" id="pressure-analysis" role="tabpanel">
      <div class="d-flex justify-content-center align-items-center mb-3">
        <label for="pressure-timer-dropdown" class="me-2">Timer Name:</label>
        <select id="pressure-timer-dropdown" class="form-select me-3" style="max-width: 200px;">
          <option value="">Select Timer</option>
        </select>
        <button id="analyze-pressure-btn" class="btn btn-primary">Analyze</button>
      </div>
      <div id="pressure-chart-container" class="mt-3 text-center" style="max-height: 600px; overflow: hidden;">
        <p class="text-muted">Select a timer to view pressure analysis</p>
      </div>
    </div>
    <div class="tab-pane fade" id="fertigation-logs" role="tabpanel">
      <div class="card mt-4">
        <div class="card-body">
          <h5 class="card-title text-muted">Valve Queue</h5>
          <div id="valve-group-queue-controls" class="mb-3">
            <button id="add-valve-group-btn" class="btn btn-primary">Select Valves and Add to Queue</button>
            <p class="text-muted mt-2">Choose multiple valves using the modal interface.</p>
          </div>
          <h6 class="mt-3">Queue:</h6>
          <ul id="valve-group-queue-list" class="list-group mb-3"></ul>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">Tank History</h5>
              <div class="table-responsive">
                <table class="table">
                  <thead>
                    <tr>
                      <th>Date</th>
                      <th>Duration</th>
                      <th>Active Timers</th>
                      <th>Notes</th>
                    </tr>
                  </thead>
                  <tbody id="fertigation-history">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- User Profile Modal -->
  <div class="modal fade" id="userModal" tabindex="-1" aria-labelledby="userModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center p-4">
        <img
          id="modal-user-photo"
          src="images/user-default.png"
          alt="Profile Picture"
          class="rounded-circle mb-3"
          style="width:80px;height:80px;"
        />
        <h5 id="modal-user-name">Not signed in</h5>
        <p id="modal-user-email" class="text-muted mb-3"></p>

        <button id="login-btn" class="btn btn-primary w-100 mb-2">Sign in with Google</button>
        <button id="logout-btn" class="btn btn-outline-danger w-100" style="display:none;">Log Out</button>
      </div>
    </div>
  </div>
</div>

  <script src="firebase-config.js"></script>
  <script src="main.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
